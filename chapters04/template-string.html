<!DOCTYPE html><html><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><title>模板字符串 - learn es6</title><meta name="description" content=""><meta name="author" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="stylesheet" href="../assets/css/bulma.min.css"><link rel="stylesheet" href="../assets/css/app.css"><!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="shortcut icon" href=""></head><body dir="ltr"><nav class="columns navbar"><div class="column logo is-3 is-offset-1"><a class="is-brand" href="../index.html">learn es6</a></div></nav><div class="columns content"><div class="column is-2-desktop is-3-widescreen is-hidden-touch"></div><div class="column article-container is-11-tablet is-8-desktop is-6-widescreen"><div class="breadcrumb-area"><a href="../index.html" class="breadcrumb-item">Home</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../chapters04/index.html" class="breadcrumb-item">第四章 字符串的扩展</a><span class="breadcrumb-delimiter"> &gt; </span><a href="../chapters04/template-string.html" class="breadcrumb-item">模板字符串</a></div><h1 class="article-title">模板字符串</h1><div class="article"><h1 id="模板字符串">模板字符串 <a class="markdownIt-Anchor" href="#模板字符串">#</a></h1><h2 id="产生原因">产生原因 <a class="markdownIt-Anchor" href="#产生原因">#</a></h2><p>传统的 <code>JavaScript</code> 语言，输出<code>模板</code>通常是这样写的（下面使用了 <code>jQuery</code> 的方法）。</p><pre class="hljs"><code>$(<span class="hljs-string">'#result'</span>).append(
  <span class="hljs-string">'There are &lt;b&gt;'</span> + basket.count + <span class="hljs-string">'&lt;/b&gt; '</span> +
  <span class="hljs-string">'items in your basket, '</span> +
  <span class="hljs-string">'&lt;em&gt;'</span> + basket.onSale +
  <span class="hljs-string">'&lt;/em&gt; are on sale!'</span>
);
</code></pre><hr><h2 id="优化结果">优化结果 <a class="markdownIt-Anchor" href="#优化结果">#</a></h2><h3 id="基础使用">基础使用 <a class="markdownIt-Anchor" href="#基础使用">#</a></h3><p>之前写法相当<code>繁琐</code>不方便，<code>ES6</code> 引入了<code>模板字符串</code>解决这个<code>问题</code>。</p><pre class="hljs"><code>$(<span class="hljs-string">'#result'</span>).append(<span class="hljs-string">`
  There are &lt;b&gt;<span class="hljs-subst">${basket.count}</span>&lt;/b&gt; items
   in your basket, &lt;em&gt;<span class="hljs-subst">${basket.onSale}</span>&lt;/em&gt;
  are on sale!
`</span>);
</code></pre><p><code>模板字符串（template string）</code>是<code>增加版</code>的<code>字符串</code>，用<code>反引号</code>作为<code>标识</code>，它可以当作<code>普通字符串</code>使用，也可以用来定义<code>多行字符串</code>。</p><p>使用<code>模板字符串</code>表示<code>多行字符串</code>，所有的<code>空格</code>和<code>缩进</code>都会被保留在<code>输出</code>之中。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-comment">// 普通字符串</span>
    log(<span class="hljs-string">`In JavaScript '\n' is a line-feed.`</span>);
    <span class="hljs-comment">// In JavaScript '</span>
    <span class="hljs-comment">// ' is a line-feed.</span>

    <span class="hljs-comment">// 多行字符串</span>
    log(<span class="hljs-string">`In JavaScript this is
 not legal.`</span>);
    <span class="hljs-comment">// In JavaScript this is</span>
    <span class="hljs-comment">// not legal.</span>

    log(<span class="hljs-string">`string text line 1
string text line 2`</span>);
    <span class="hljs-comment">// string text line 1</span>
    <span class="hljs-comment">// string text line 2</span>

    $(<span class="hljs-string">'#list'</span>).html(<span class="hljs-string">`
        &lt;ul&gt;
        &lt;li&gt;first&lt;/li&gt;
        &lt;li&gt;second&lt;/li&gt;
        &lt;/ul&gt;
    `</span>);
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="使用反引号">使用反引号 <a class="markdownIt-Anchor" href="#使用反引号">#</a></h3><p><code>代码</code>中的<code>模板字符串</code>，都是用<code>反引号</code>表示。</p><p>如果在<code>模板字符串</code>中需要使用<code>反引号</code>，则前面要用<code>反斜杠</code>转义。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-keyword">let</span> greeting = <span class="hljs-string">`\`Yo\` World!`</span>;
    log(greeting);<span class="hljs-comment">// `Yo` World!</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="使用变量">使用变量 <a class="markdownIt-Anchor" href="#使用变量">#</a></h3><p><code>模板字符串</code>中嵌入<code>变量</code>，需要将<code>变量名</code>写在<code>${}</code>之中。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-comment">// 字符串中嵌入变量</span>
    <span class="hljs-keyword">let</span> name = <span class="hljs-string">"Bob"</span>,
        time = <span class="hljs-string">"today"</span>;
    log(<span class="hljs-string">`Hello <span class="hljs-subst">${name}</span>, how are you <span class="hljs-subst">${time}</span>?`</span>);
    <span class="hljs-comment">// Hello Bob, how are you today?</span>

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span>(<span class="hljs-params">user, action</span>) </span>{
        <span class="hljs-keyword">if</span> (!user.hasPrivilege(action)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
            <span class="hljs-comment">// 传统写法为</span>
            <span class="hljs-comment">// 'User '</span>
            <span class="hljs-comment">// + user.name</span>
            <span class="hljs-comment">// + ' is not authorized to do '</span>
            <span class="hljs-comment">// + action</span>
            <span class="hljs-comment">// + '.'</span>
            <span class="hljs-string">`User <span class="hljs-subst">${user.name}</span> is not authorized to do <span class="hljs-subst">${action}</span>.`</span>);
        }
    }
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="使用表达式">使用表达式 <a class="markdownIt-Anchor" href="#使用表达式">#</a></h3><blockquote><p>简单表达式</p></blockquote><p><code>模板字符串</code>中<code>大括号</code>内部可以放入任意的 <code>JavaScript 表达式</code>，可以进行<code>运算</code>，以及引用对象<code>属性</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> y = <span class="hljs-number">2</span>;

    log(<span class="hljs-string">`<span class="hljs-subst">${x}</span> + <span class="hljs-subst">${y}</span> = <span class="hljs-subst">${x + y}</span>`</span>);
    <span class="hljs-comment">// "1 + 2 = 3"</span>

    log(<span class="hljs-string">`<span class="hljs-subst">${x}</span> + <span class="hljs-subst">${y * <span class="hljs-number">2</span>}</span> = <span class="hljs-subst">${x + y * <span class="hljs-number">2</span>}</span>`</span>);
    <span class="hljs-comment">// "1 + 4 = 5"</span>

    <span class="hljs-keyword">let</span> obj = {
        <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">2</span>
    };
    log(<span class="hljs-string">`<span class="hljs-subst">${obj.x + obj.y}</span>`</span>);
    <span class="hljs-comment">// "3"</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><blockquote><p>调用函数</p></blockquote><p><code>模板字符串</code>之中还能调用<code>函数</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World"</span>;
    }

    log(<span class="hljs-string">`foo <span class="hljs-subst">${fn()}</span> bar`</span>);
    <span class="hljs-comment">// foo Hello World bar</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><blockquote><p>字符串变量</p></blockquote><p>由于<code>模板字符串</code>的<code>大括号内部</code>，就是执行 <code>JavaScript 代码</code>，因此如果<code>大括号内部</code>是一个<code>字符串</code>，将会<code>原样输出</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">`Hello <span class="hljs-subst">${<span class="hljs-string">'Melon'</span>}</span>`</span>;
    log(msg);<span class="hljs-comment">// Hello Melon</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><blockquote><p>需要时执行</p></blockquote><p>如果需要引用<code>模板字符串</code>本身，在<code>需要</code>时<code>执行</code>，可以像下面这样写。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-comment">// 写法一</span>
    <span class="hljs-keyword">let</span> str1 = <span class="hljs-string">'return '</span> + <span class="hljs-string">'`Hello ${name}!`'</span>;
    <span class="hljs-keyword">let</span> func1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'name'</span>, str1);
    log(func1(<span class="hljs-string">'Melon'</span>)); <span class="hljs-comment">// "Hello Melon!"</span>

    <span class="hljs-comment">// 写法二</span>
    <span class="hljs-keyword">let</span> str2 = <span class="hljs-string">'(name) =&gt; `Hello ${name}!`'</span>;
    <span class="hljs-keyword">let</span> func2 = <span class="hljs-built_in">eval</span>.call(<span class="hljs-literal">null</span>, str2);
    log(func2(<span class="hljs-string">'Melon'</span>)); <span class="hljs-comment">// "Hello Melon!"</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="使用对象变量">使用对象变量 <a class="markdownIt-Anchor" href="#使用对象变量">#</a></h3><p>如果<code>大括号</code>中的值不是<code>字符串</code>，将按照一般的<code>规则</code>转为<code>字符串</code>。</p><p>比如，<code>大括号</code>中是一个<code>对象</code>，将默认调用<code>对象</code>的<code>toString</code>方法。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-keyword">let</span> a = [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
    <span class="hljs-keyword">let</span> o = {<span class="hljs-attr">melon</span>:<span class="hljs-number">1</span>};
    <span class="hljs-keyword">let</span> d = <span class="hljs-built_in">Reflect</span>.construct(<span class="hljs-built_in">Date</span>,[]);

    log(<span class="hljs-string">`<span class="hljs-subst">${a}</span> + <span class="hljs-subst">${o}</span> = <span class="hljs-subst">${d}</span>`</span>);
    <span class="hljs-comment">// 1,3,4 + [object Object] = Mon Feb 11 2019 23:45:23 GMT+0800 (GMT+08:00)</span>

})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="使用未声明变量">使用未声明变量 <a class="markdownIt-Anchor" href="#使用未声明变量">#</a></h3><p>如果<code>模板字符串</code>中的<code>变量</code>没有<code>声明</code>，将<code>报错</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-comment">// 变量place没有声明</span>
    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">`Hello, <span class="hljs-subst">${place}</span>`</span>;<span class="hljs-comment">// ReferenceError: place is not defined</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="模板嵌套">模板嵌套 <a class="markdownIt-Anchor" href="#模板嵌套">#</a></h3><p><code>模板字符串</code>可以<code>嵌套</code>。</p><p>下面<code>tmpl</code>方法中，<code>模板字符串</code>的<code>变量</code>之中，又嵌入了另一个<code>模板字符串</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-keyword">const</span> tmpl = <span class="hljs-function"><span class="hljs-params">addrs</span> =&gt;</span> <span class="hljs-string">`
    &lt;table&gt;
    <span class="hljs-subst">${addrs.map(addr =&gt; <span class="hljs-string">`
      &lt;tr&gt;&lt;td&gt;<span class="hljs-subst">${addr.first}</span>&lt;/td&gt;&lt;/tr&gt;
      &lt;tr&gt;&lt;td&gt;<span class="hljs-subst">${addr.last}</span>&lt;/td&gt;&lt;/tr&gt;
    `</span>).join(<span class="hljs-string">''</span>)}</span>
    &lt;/table&gt;
  `</span>;

    <span class="hljs-keyword">const</span> data = [{
            <span class="hljs-attr">first</span>: <span class="hljs-string">'&lt;Jane&gt;'</span>,
            <span class="hljs-attr">last</span>: <span class="hljs-string">'Bond'</span>
        },
        {
            <span class="hljs-attr">first</span>: <span class="hljs-string">'Lars'</span>,
            <span class="hljs-attr">last</span>: <span class="hljs-string">'&lt;Croft&gt;'</span>
        },
    ];

    log(tmpl(data));
    <span class="hljs-comment">// &lt;table&gt;</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">//   &lt;tr&gt;&lt;td&gt;&lt;Jane&gt;&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="hljs-comment">//   &lt;tr&gt;&lt;td&gt;Bond&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">//   &lt;tr&gt;&lt;td&gt;Lars&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="hljs-comment">//   &lt;tr&gt;&lt;td&gt;&lt;Croft&gt;&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// &lt;/table&gt;</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h2 id="模板编译">模板编译 <a class="markdownIt-Anchor" href="#模板编译">#</a></h2><h3 id="准备需要转换的模板">准备需要转换的模板 <a class="markdownIt-Anchor" href="#准备需要转换的模板">#</a></h3><pre class="hljs"><code><span class="hljs-keyword">const</span> template = <span class="hljs-string">`
&lt;ul&gt;
  &lt;% for(let i=0; i &lt; data.supplies.length; i++) { %&gt;
    &lt;li&gt;&lt;%= data.supplies[i] %&gt;&lt;/li&gt;
  &lt;% } %&gt;
&lt;/ul&gt;
`</span>;
</code></pre><p>上面代码在<code>模板字符串</code>之中，放置了一个<code>常规模板</code>。</p><p>该模板使用<code>&lt;%...%&gt;</code>放置 <code>JavaScript</code> 代码，使用<code>&lt;%= ... %&gt;</code>输出 <code>JavaScript</code> 表达式。</p><hr><h3 id="之前转换的方法">之前转换的方法 <a class="markdownIt-Anchor" href="#之前转换的方法">#</a></h3><p>将其转换为 <code>JavaScript 表达式</code>字符串。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tmpl</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">const</span> arr = [];
        arr.push(<span class="hljs-string">'&lt;ul&gt;'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.supplies.length; i++) {
            arr.push(<span class="hljs-string">'\n\t&lt;li&gt;'</span>);
            arr.push(data.supplies[i]);
            arr.push(<span class="hljs-string">'&lt;/li&gt;'</span>);
        };
        arr.push(<span class="hljs-string">'\n&lt;/ul&gt;'</span>);
        <span class="hljs-keyword">return</span> arr.join(<span class="hljs-string">''</span>);
    }

    <span class="hljs-keyword">const</span> data = {
        <span class="hljs-attr">supplies</span>: [<span class="hljs-string">"broom"</span>, <span class="hljs-string">"mop"</span>, <span class="hljs-string">"cleaner"</span>]
    };
    log(tmpl(data));
    <span class="hljs-comment">// &lt;ul&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;broom&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;mop&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;cleaner&lt;/li&gt;</span>
    <span class="hljs-comment">// &lt;/ul&gt;</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="正则加echo和eval">正则加echo和eval <a class="markdownIt-Anchor" href="#正则加echo和eval">#</a></h3><p>使用<code>正则表达式</code>将模板中<code>&lt;%= ... %&gt;</code>转换为<code>echo</code>字符串拼接方法，然后再结合<code>模板字符串</code>，转译最后的编译方法<code>完整体</code>，最后再调用<code>eval</code>动态执行<code>函数编译</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">template</span>) </span>{
        <span class="hljs-keyword">const</span> evalExpr = <span class="hljs-regexp">/&lt;%=(.+?)%&gt;/g</span>;
        <span class="hljs-keyword">const</span> expr = <span class="hljs-regexp">/&lt;%([\s\S]+?)%&gt;/g</span>;

        template = template.replace(evalExpr, <span class="hljs-string">'`); \n  echo( $1 ); \n  echo(`'</span>)

        template = template.replace(expr, <span class="hljs-string">'`); \n $1 \n  echo(`'</span>);

        template = <span class="hljs-string">'echo(`'</span> + template + <span class="hljs-string">'`);'</span>;

        <span class="hljs-keyword">let</span> script =
            <span class="hljs-string">`(function parse(data){
          let output = "";

          function echo(html){
            output += html;
          }

          <span class="hljs-subst">${ template }</span>

          return output;
        })`</span>;

        <span class="hljs-keyword">return</span> script;
    }

    <span class="hljs-keyword">const</span> data = {
        <span class="hljs-attr">supplies</span>: [<span class="hljs-string">"broom"</span>, <span class="hljs-string">"mop"</span>, <span class="hljs-string">"cleaner"</span>]
    };

    <span class="hljs-keyword">const</span> temp = <span class="hljs-string">`
    &lt;ul&gt;
        &lt;% for(let i=0; i &lt; data.supplies.length; i++) { %&gt;
            &lt;li&gt;&lt;%= data.supplies[i] %&gt;&lt;/li&gt;
        &lt;% } %&gt;
    &lt;/ul&gt;
    `</span>;

    <span class="hljs-comment">// let tmpl = new Function(temp,compile);</span>
    <span class="hljs-keyword">const</span> compileStr = compile(temp);
    log(compileStr);

    <span class="hljs-comment">// (function parse(data) {</span>
    <span class="hljs-comment">//     let output = "";</span>

    <span class="hljs-comment">//     function echo(html) {</span>
    <span class="hljs-comment">//         output += html;</span>
    <span class="hljs-comment">//     }</span>

    <span class="hljs-comment">//     echo(`</span>
    <span class="hljs-comment">//         &lt;ul&gt;</span>
    <span class="hljs-comment">//             `);</span>
    <span class="hljs-comment">//     for (let i = 0; i &lt; data.supplies.length; i++) {</span>
    <span class="hljs-comment">//         echo(`</span>
    <span class="hljs-comment">//                 &lt;li&gt;`);</span>
    <span class="hljs-comment">//         echo(data.supplies[i]);</span>
    <span class="hljs-comment">//         echo(`&lt;/li&gt;</span>
    <span class="hljs-comment">//             `);</span>
    <span class="hljs-comment">//     }</span>
    <span class="hljs-comment">//     echo(`</span>
    <span class="hljs-comment">//         &lt;/ul&gt;</span>
    <span class="hljs-comment">//         `);</span>

    <span class="hljs-comment">//     return output;</span>
    <span class="hljs-comment">// })</span>

    <span class="hljs-keyword">let</span> tmpl = <span class="hljs-built_in">eval</span>(compileStr);
    log(tmpl(data));
    <span class="hljs-comment">// &lt;ul&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;broom&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;mop&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;cleaner&lt;/li&gt;</span>
    <span class="hljs-comment">// &lt;/ul&gt;</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h3 id="正则加数组和eval">正则加数组和eval <a class="markdownIt-Anchor" href="#正则加数组和eval">#</a></h3><p>使用<code>正则表达式</code>将模板中<code>&lt;%= ... %&gt;</code>转换为<code>arr.push</code>字符串拼接方法，然后再结合<code>模板字符串</code>，转译最后的编译方法<code>完整体</code>，最后再调用<code>eval</code>动态执行<code>函数编译</code>。</p><pre class="hljs"><code>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, S</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">template</span>) </span>{
        <span class="hljs-keyword">const</span> evalExpr = <span class="hljs-regexp">/&lt;%=(.+?)%&gt;/g</span>;
        <span class="hljs-keyword">const</span> expr = <span class="hljs-regexp">/&lt;%([\s\S]+?)%&gt;/g</span>;

        template = template.replace(evalExpr, <span class="hljs-string">'`); \n  arr.push( $1 ); \n  arr.push(`'</span>);
        <span class="hljs-comment">// 替换模板字符串中的&lt;%=...%&gt;中的值  </span>
        <span class="hljs-comment">// 比如将 '&lt;%= data.supplies[i] %&gt;'</span>
        <span class="hljs-comment">// 转换为 '`);\n  arr.push( data.supplies[i]); \n  arr.push(`'</span>

        template = template.replace(expr, <span class="hljs-string">'`); \n $1 \n  arr.push(`'</span>);
        <span class="hljs-comment">// 替换模板字符串中的&lt;%...%&gt;中的值  </span>
        <span class="hljs-comment">// 比如将 '&lt;% for(let i=0; i &lt; data.supplies.length; i++) { %&gt;'</span>
        <span class="hljs-comment">// 转换为 '`);\n  for(let i=0; i &lt; data.supplies.length; i++)  \n  arr.push(`'</span>

        template = <span class="hljs-string">'arr.push(`'</span> + template + <span class="hljs-string">'`);'</span>; <span class="hljs-comment">// 做最外层的包裹</span>

        <span class="hljs-keyword">let</span> script =
            <span class="hljs-string">`(function parse(data){
                const arr = [];

                <span class="hljs-subst">${ template }</span>

                return arr.join('');
            })`</span>;

        <span class="hljs-keyword">return</span> script;
    }

    <span class="hljs-keyword">const</span> data = {
        <span class="hljs-attr">supplies</span>: [<span class="hljs-string">"broom"</span>, <span class="hljs-string">"mop"</span>, <span class="hljs-string">"cleaner"</span>]
    };

    <span class="hljs-keyword">const</span> temp = <span class="hljs-string">`
    &lt;ul&gt;
        &lt;% for(let i=0; i &lt; data.supplies.length; i++) { %&gt;
            &lt;li&gt;&lt;%= data.supplies[i] %&gt;&lt;/li&gt;
        &lt;% } %&gt;
    &lt;/ul&gt;
    `</span>;

    <span class="hljs-comment">// let tmpl = new Function(temp,compile);</span>
    <span class="hljs-keyword">const</span> compileStr = compile(temp);
    log(compileStr);

    <span class="hljs-comment">// (function parse(data){</span>
    <span class="hljs-comment">//     const arr = [];</span>

    <span class="hljs-comment">//     arr.push(`</span>
    <span class="hljs-comment">//         &lt;ul&gt;</span>
    <span class="hljs-comment">//     `);</span>
    <span class="hljs-comment">//     for(let i=0; i &lt; data.supplies.length; i++) {  </span>
    <span class="hljs-comment">//         arr.push(`</span>
    <span class="hljs-comment">//             &lt;li&gt;`);</span>
    <span class="hljs-comment">//         arr.push(  data.supplies[i]  );</span>
    <span class="hljs-comment">//         arr.push(`&lt;/li&gt;</span>
    <span class="hljs-comment">//         `);</span>
    <span class="hljs-comment">//     }  </span>
    <span class="hljs-comment">//     arr.push(`</span>
    <span class="hljs-comment">//     &lt;/ul&gt;</span>
    <span class="hljs-comment">// `);</span>

    <span class="hljs-comment">// return arr.join('');</span>
    <span class="hljs-comment">// })</span>

    <span class="hljs-keyword">let</span> tmpl = <span class="hljs-built_in">eval</span>(compileStr);
    log(tmpl(data));
    <span class="hljs-comment">// &lt;ul&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;broom&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;mop&lt;/li&gt;</span>
    <span class="hljs-comment">//     &lt;li&gt;cleaner&lt;/li&gt;</span>
    <span class="hljs-comment">// &lt;/ul&gt;</span>
})(<span class="hljs-built_in">console</span>.log, <span class="hljs-built_in">String</span>)
</code></pre><hr><h2 id="模板字符串的限制">模板字符串的限制 <a class="markdownIt-Anchor" href="#模板字符串的限制">#</a></h2><p>前面提到<code>标签模板</code>里面，可以内嵌其他<code>语言</code>。</p><p>但是，<code>模板字符串</code>默认会将<code>字符串转义</code>，导致无法嵌入<code>其他语言</code>。</p><p>举例来说，标签模板里面可以嵌入 <code>LaTEX</code> 语言。</p><pre class="hljs"><code>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">latex</span>(<span class="hljs-params">strings</span>) </span>{
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">let</span> <span class="hljs-built_in">document</span> = latex<span class="hljs-string">`
\newcommand{\fun}{\textbf{Fun!}}  // 正常工作
\newcommand{\unicode}{\textbf{Unicode!}} // 报错
\newcommand{\xerxes}{\textbf{King!}} // 报错

Breve over the h goes \u{h}ere // 报错
`</span>
</code></pre><p>上面代码中，变量<code>document</code>内嵌的<code>模板字符串</code>，对于 <code>LaTEX</code> 语言来说完全是<code>合法</code>的。</p><p>但是 <code>JavaScript</code> 引擎会报错。原因就在于<code>字符串</code>的<code>转义</code>。</p><p><code>模板字符串</code>会将<code>\u00FF</code>和<code>\u{42}</code>当作 <code>Unicode</code> 字符进行转义，所以<code>\unicode</code>解析时报错；</p><p>而<code>\x56</code>会被当作<code>十六进制</code>字符串转义，所以<code>\xerxes</code>会报错。</p><p>也就是说，<code>\u</code>和<code>\x</code>在 <code>LaTEX</code> 里面有<code>特殊含义</code>，但是 <code>JavaScript</code> 将它们转义了。</p><p>为了解决这个问题，<code>ES2018</code> 放松了对<code>标签模板</code>里面的<code>字符串转义</code>的限制。</p><p>如果遇到<code>不合法</code>的<code>字符串转义</code>，就返回<code>undefined</code>，而不是报错，并且从<code>raw</code>属性上面可以得到<code>原始字符串</code>。</p><pre class="hljs"><code>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tag</span>(<span class="hljs-params">strs</span>) </span>{
  strs[<span class="hljs-number">0</span>] === <span class="hljs-literal">undefined</span>
  strs.raw[<span class="hljs-number">0</span>] === <span class="hljs-string">"\\unicode and \\u{55}"</span>;
}
tag<span class="hljs-string">`\unicode and \u{55}`</span>
</code></pre><p>上面代码中，<code>模板字符串</code>原本是应该报错的，但是由于<code>放松</code>了对<code>字符串转义</code>的<code>限制</code>，所以不报错了，<code>JavaScript</code> 引擎将第一个字符设置为<code>undefined</code>/</p><p>但是<code>raw</code>属性依然可以得到<code>原始字符串</code>，因此<code>tag</code>函数还是可以对<code>原字符串</code>进行处理。</p><p>注意，这种对<code>字符串转义</code>的<code>放松</code>，只在<code>标签模板解析</code>字符串时生效，不是<code>标签模板</code>的场合，依然会<code>报错</code>。</p><pre class="hljs"><code>
<span class="hljs-keyword">let</span> bad = <span class="hljs-string">`bad escape sequence: \unicode`</span>; <span class="hljs-comment">// 报错</span>
</code></pre></div><div dir="ltr" class="level article-bar is-mobile"><div class="level-item has-text-centered"><a title="previous page" class="previouse-article-link" href="../chapters04/instance-function-extend.html"><span class="icon icon-previous" data-icon="previous"></span><span class="link-content">&laquo; Previous</span></a></div><div class="level-item has-text-centered"><a title="font size" class="link-item link-item-size"><span class="icon icon-size" data-icon="size"></span></a></div><div class="level-item has-text-centered"><a title="table of content" class="link-item link-item-toc"><span class="icon icon-toc" data-icon="toc"></span></a></div><div class="level-item has-text-centered"><a title="top" href="#"><span class="icon icon-up" data-icon="up"></span> <span class="link-content">⤊ Top</span></a></div><div class="level-item has-text-centered"><a title="next page" class="next-article-link" href="../chapters04/string-Iterator.html"><span class="icon icon-next" data-icon="next"></span><span class="link-content">Next &raquo;</span></a></div></div></div><div class="column is-2-widescreen is-hidden"></div></div><div class="columns foot"><div class="column is-3 is-offset-9 build-by">Build by <a href="https://github.com/ruanyf/loppo" target="_blank">Loppo</a> 0.6.16</div></div><div class="book-toc notification is-warning is-hidden"><h3>Table of chapters &nbsp;<span class="title-close"><a class="button is-danger"> Close</a></span></h3><ul class="chapter-area"><li class="chapter-item"><a href="../chapters01/index.html">第一章 ECMAScript 6 简介</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters01/base-js.html">js基础前置知识</a></li><li class="chapter-item"><a href="../chapters01/base-es.html">es基础前置知识</a></li><li class="chapter-item"><a href="../chapters01/Babel.html">通过Babel使用ES6</a></li><li class="chapter-item"><a href="../chapters01/Traceur.html">通过Traceur使用ES6</a></li><li class="chapter-item"><a href="../chapters01/stage-00.html">Strawman 阶段的 proposals</a></li><li class="chapter-item"><a href="../chapters01/stage-01.html">Proposal 阶段的 proposals</a></li><li class="chapter-item"><a href="../chapters01/stage-02.html">Draft 阶段的 proposals</a></li><li class="chapter-item"><a href="../chapters01/active-proposals.html">Candidate 阶段的 proposals</a></li><li class="chapter-item"><a href="../chapters01/stage-04.html">Finished 阶段的 proposals</a></li></ul><li class="chapter-item"><a href="../chapters02/index.html">第二章 let和const命令</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters02/base.html">前置知识了解</a></li><li class="chapter-item"><a href="../chapters02/let.html">let 命令</a></li><li class="chapter-item"><a href="../chapters02/const.html">const 命令</a></li><li class="chapter-item"><a href="../chapters02/statement-details.html">语句进阶说明</a></li></ul><li class="chapter-item"><a href="../chapters03/index.html">第三章 变量的解构赋值</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters03/base.html">基础数据结构</a></li><li class="chapter-item"><a href="../chapters03/complex.html">复杂数据结构</a></li><li class="chapter-item"><a href="../chapters03/parentheses.html">圆括号问题</a></li><li class="chapter-item"><a href="../chapters03/use.html">用途</a></li></ul><li class="chapter-item"><a href="../chapters04/index.html">第四章 字符串的扩展</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-collapse" data-icon="collapse"></span></a></li><ul class="chapter-level-1 chapter-level-1-current"><li class="chapter-item"><a href="../chapters04/unicode.html">字符的 Unicode 表示法</a></li><li class="chapter-item"><a href="../chapters04/prototype-function-extend.html">原型对象方法扩展</a></li><li class="chapter-item"><a href="../chapters04/instance-function-extend.html">实例对象方法扩展</a></li><li class="chapter-item chapter-item-current"><a href="../chapters04/template-string.html">模板字符串</a></li><li class="chapter-item"><a href="../chapters04/string-Iterator.html">字符串的遍历器接口</a></li><li class="chapter-item"><a href="../chapters04/tag-template.html">标签模板</a></li></ul><li class="chapter-item"><a href="../chapters05/index.html">第五章 正则的扩展</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters05/constructor.html">RegExp 构造函数</a></li><li class="chapter-item"><a href="../chapters05/base.html">RegExp 基础使用</a></li><li class="chapter-item"><a href="../chapters05/prototype-attribute.html">RegExp 原型属性</a></li><li class="chapter-item"><a href="../chapters05/modifier.html">RegExp 修饰符</a></li><li class="chapter-item"><a href="../chapters05/assert.html">RegExp 断言</a></li><li class="chapter-item"><a href="../chapters05/string-with-regExp.html">String中正则相关方法</a></li><li class="chapter-item"><a href="../chapters05/named-group-matching.html">具名组匹配</a></li><li class="chapter-item"><a href="../chapters05/unicode-attribute-class.html">Unicode 属性类</a></li></ul><li class="chapter-item"><a href="../chapters06/index.html">第六章 数值的扩展</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters06/base-notation.html">Number 进制表示法</a></li><li class="chapter-item"><a href="../chapters06/prototype-attribute.html">Number 原型属性</a></li><li class="chapter-item"><a href="../chapters06/base-function-extend.html">Number 对象方法扩展</a></li><li class="chapter-item"><a href="../chapters06/prototype-function-extend.html">Number 原型对象方法扩展</a></li><li class="chapter-item"><a href="../chapters06/math-extension.html">math 对象扩展</a></li><li class="chapter-item"><a href="../chapters06/exponent-operator.html">指数运算符</a></li></ul><li class="chapter-item"><a href="../chapters07/index.html">第七章 函数的扩展</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters07/arrow-function.html">箭头函数</a></li><li class="chapter-item"><a href="../chapters07/strict-mode.html">严格模式</a></li><li class="chapter-item"><a href="../chapters07/function-parameter-improvement.html">函数参数改进</a></li><li class="chapter-item"><a href="../chapters07/the-name-attribute-of-the-function.html">函数的name属性</a></li><li class="chapter-item"><a href="../chapters07/tail-call-optimization.html">尾调用优化</a></li></ul><li class="chapter-item"><a href="../chapters08/index.html">第八章 数组的扩展</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters08/extension-operator.html">扩展运算符</a></li><li class="chapter-item"><a href="../chapters08/prototype-function-extend.html">原型对象方法扩展</a></li><li class="chapter-item"><a href="../chapters08/instance-function-extend.html">实例对象方法扩展</a></li><li class="chapter-item"><a href="../chapters08/empty-space-processing-of-array.html">数组的空位处理</a></li><li class="chapter-item"><a href="../chapters08/pipeline-optimization-of-arrays.html">数组的管道运算优化</a></li></ul><li class="chapter-item"><a href="../chapters09/index.html">第九章 ts学习</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters09/history.html">ts历史</a></li><li class="chapter-item"><a href="../chapters09/advantages-and-disadvantages.html">ts优势与劣势</a></li><li class="chapter-item"><a href="../chapters09/learn-primitive-type.html">基础类型学习</a></li><li class="chapter-item"><a href="../chapters09/learn-derivative-type.html">衍生类型基础学习</a></li><li class="chapter-item"><a href="../chapters09/Enum.html">衍生类型之Enum</a></li><li class="chapter-item"><a href="../chapters09/interface.html">衍生类型之interface</a></li><li class="chapter-item"><a href="../chapters09/Class.html">衍生类型之Class</a></li><li class="chapter-item"><a href="../chapters09/ts-util.html">ts 高级工具用法</a></li></ul><li class="chapter-item"><a href="../chapters10/index.html">第十章 react学习</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters10/history.html">react历史</a></li><li class="chapter-item"><a href="../chapters10/version-management.html">react版本管理</a></li><li class="chapter-item"><a href="../chapters10/advantages-and-disadvantages.html">react优势与劣势</a></li><li class="chapter-item"><a href="../chapters10/base.html">react基础语法</a></li><li class="chapter-item"><a href="../chapters10/common-package.html">react常用组件包</a></li><li class="chapter-item"><a href="../chapters10/family-bucket.html">react全家桶</a></li><li class="chapter-item"><a href="../chapters10/ecosphere.html">react的生态圈</a></li><li class="chapter-item"><a href="../chapters10/substitute-product.html">react和替代产品类比</a></li></ul><li class="chapter-item"><a href="../chapters11/index.html">第十一章 webpack学习</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters11/history.html">webpack历史</a></li><li class="chapter-item"><a href="../chapters11/version-management.html">webpack版本管理</a></li><li class="chapter-item"><a href="../chapters11/advantages-and-disadvantages.html">webpack优势与劣势</a></li><li class="chapter-item"><a href="../chapters11/base-config.html">webpack项目基础配置</a></li><li class="chapter-item"><a href="../chapters11/common-package.html">webpack常用组件包</a></li><li class="chapter-item"><a href="../chapters11/ecosphere.html">webpack的生态圈</a></li><li class="chapter-item"><a href="../chapters11/substitute-product.html">webpack和替代产品类比</a></li></ul><li class="chapter-item"><a href="../chapters12/index.html">第十二章 微信小程序学习</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters12/history.html">微信小程序历史</a></li><li class="chapter-item"><a href="../chapters12/version-management.html">微信小程序版本管理</a></li><li class="chapter-item"><a href="../chapters12/advantages-and-disadvantages.html">微信小程序优势与劣势</a></li><li class="chapter-item"><a href="../chapters12/base.html">微信小程序基础学习</a></li><li class="chapter-item"><a href="../chapters12/common-ui-package.html">微信小程序常用UI库</a></li><li class="chapter-item"><a href="../chapters12/ecosphere.html">微信小程序的生态圈</a></li><li class="chapter-item"><a href="../chapters12/cross-platform.html">微信小程序跨平台</a></li><li class="chapter-item"><a href="../chapters12/substitute-product.html">微信小程序和替代产品类比</a></li></ul><li class="chapter-item"><a href="../chapters13/index.html">第十三章 web安全方案</a>&nbsp;<a class="first-level-collapse"><span class="icon icon-expand" data-icon="expand"></span></a></li><ul class="chapter-level-1"><li class="chapter-item"><a href="../chapters13/common-web-risks.html">常见web风险</a></li><li class="chapter-item"><a href="../chapters13/monitoring-system.html">前端监控体系</a></li><li class="chapter-item"><a href="../chapters13/performance-optimization.html">前端性能优化</a></li><li class="chapter-item"><a href="../chapters13/security-prevention-and-control.html">前端安全防控</a></li><li class="chapter-item"><a href="../chapters13/test-system.html">前端测试体系</a></li></ul></ul></div><div class="progress-indicator"></div><!-- SCRIPTS --><script>var LOPPO={current_path:"chapters04/template-string.md",relative_root_path:"../",article_toc:'<ul class="markdownIt-TOC">\n<li><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0">产生原因</a></li>\n<li><a href="#%E4%BC%98%E5%8C%96%E7%BB%93%E6%9E%9C">优化结果</a>\n<ul>\n<li><a href="#%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8">基础使用</a></li>\n<li><a href="#%E4%BD%BF%E7%94%A8%E5%8F%8D%E5%BC%95%E5%8F%B7">使用反引号</a></li>\n<li><a href="#%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F">使用变量</a></li>\n<li><a href="#%E4%BD%BF%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">使用表达式</a></li>\n<li><a href="#%E4%BD%BF%E7%94%A8%E5%AF%B9%E8%B1%A1%E5%8F%98%E9%87%8F">使用对象变量</a></li>\n<li><a href="#%E4%BD%BF%E7%94%A8%E6%9C%AA%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F">使用未声明变量</a></li>\n<li><a href="#%E6%A8%A1%E6%9D%BF%E5%B5%8C%E5%A5%97">模板嵌套</a></li>\n</ul>\n</li>\n<li><a href="#%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91">模板编译</a>\n<ul>\n<li><a href="#%E5%87%86%E5%A4%87%E9%9C%80%E8%A6%81%E8%BD%AC%E6%8D%A2%E7%9A%84%E6%A8%A1%E6%9D%BF">准备需要转换的模板</a></li>\n<li><a href="#%E4%B9%8B%E5%89%8D%E8%BD%AC%E6%8D%A2%E7%9A%84%E6%96%B9%E6%B3%95">之前转换的方法</a></li>\n<li><a href="#%E6%AD%A3%E5%88%99%E5%8A%A0echo%E5%92%8Ceval">正则加echo和eval</a></li>\n<li><a href="#%E6%AD%A3%E5%88%99%E5%8A%A0%E6%95%B0%E7%BB%84%E5%92%8Ceval">正则加数组和eval</a></li>\n</ul>\n</li>\n<li><a href="#%E6%A8%A1%E6%9D%BF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E9%99%90%E5%88%B6">模板字符串的限制</a></li>\n</ul>\n'}</script><script src="../assets/js/app.js"></script></body></html>